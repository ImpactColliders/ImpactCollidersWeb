<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Eh Let's Play</title>
  <style>
    html,body{margin:0;height:100%;background:#000;font-family:system-ui,Arial}
    #unity-container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    #unity-canvas{width:100vw;height:100dvh;display:block;background:#000}
    #loading{position:absolute;left:50%;bottom:24px;transform:translateX(-50%);width:280px}
    #bar{height:8px;background:#2a2f3a;border-radius:6px;overflow:hidden}
    #bar>span{display:block;height:100%;width:0;background:#3aa0ff;transition:width .2s}
    #label{margin-top:8px;text-align:center;font-size:12px;color:#cfd3dc}
    #fs, #logout{
      position:fixed;top:12px;z-index:10;border:0;border-radius:8px;
      background:#1e90ff;color:#fff;font-weight:700;padding:10px 12px;cursor:pointer
    }
    #fs{right:12px;}
    #logout{left:15px;background:#ff4c4c;}
    @media (max-width:768px){#loading{bottom:12px;width:220px}}
  </style>
</head>
<body>
  <button id="logout">ðŸšª Logout</button>
  <button id="fs">â›¶ Fullscreen</button>

  <div id="unity-container">
    <canvas id="unity-canvas"></canvas>
    <div id="loading">
      <div id="bar"><span id="prog"></span></div>
      <div id="label">Loadingâ€¦ 0%</div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBFhBZWx3TUC-hdRAZ0noaD_jRTV7rgmE0",
    authDomain: "impactcolliders-afc54.firebaseapp.com",
    projectId: "impactcolliders-afc54",
    storageBucket: "impactcolliders-afc54.firebasestorage.app",
    messagingSenderId: "914866963026",
    appId: "1:914866963026:web:79dea52fc349bfe445158b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // ðŸ”’ auth state check
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("âœ… Access granted:", user.email);

      // dynamically load the Unity loader only if logged in
      const script = document.createElement("script");
      script.src = "Build/public.loader.js";
      script.onload = () => {
        const canvas = document.getElementById("unity-canvas");
        const prog = document.getElementById("prog");
        const label = document.getElementById("label");

        createUnityInstance(canvas, {
          dataUrl: buildUrl + "/public.data.unityweb.br",
          frameworkUrl: buildUrl + "/public.framework.js.unityweb.br",
          codeUrl: buildUrl + "/public.wasm.unityweb.br",
          streamingAssetsUrl: "StreamingAssets",
          companyName: "Impact Colliders",
          productName: "Eh, How Ah",
          productVersion: "0.3.2",
        }, p => {
          prog.style.width = (p * 100) + "%";
          label.textContent = "Loadingâ€¦ " + Math.round(p * 100) + "%";
        }).then(u => {
          document.getElementById("loading").style.display = "none";
          window.unityInstance = u;
        }).catch(e => {
          label.textContent = "Failed to load";
          console.error(e);
        });
      };
      document.body.appendChild(script);

    } else {
      console.warn("ðŸš« Not logged in, redirecting...");
      window.location.href = "../ehhowah.html";
    }
  });

  // ðŸšª logout handler
  document.getElementById("logout").addEventListener("click", async () => {
    try {
      await signOut(auth);
      window.location.href = "../ehhowah.html"; // back to login page
    } catch (err) {
      console.error("Logout failed:", err);
    }
  });

  // fullscreen
  const fsButton = document.getElementById("fs");
  const canvas = document.getElementById("unity-canvas");
  fsButton.addEventListener("click", async () => {
    if (document.fullscreenElement) {
      await document.exitFullscreen();
    } else {
      try { await document.documentElement.requestFullscreen(); } catch {}
      if (window.unityInstance && window.unityInstance.SetFullscreen) {
        window.unityInstance.SetFullscreen(1);
      }
    }
  });

  function resize() {
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
  }
  window.addEventListener("resize", resize, { passive:true });
  resize();
</script>
</body>
</html>
